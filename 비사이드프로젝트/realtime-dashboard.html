<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>NetMood Analyzer - ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #f0f8f0;
      min-height: 100vh;
      color: #333;
    }

    .dashboard {
      max-width: 1600px;
      margin: 0 auto;
      padding: 20px;
    }

    .header {
      text-align: center;
      margin-bottom: 30px;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 20px;
      padding: 25px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .header h1 {
      font-size: 2.2rem;
      background: linear-gradient(45deg, #667eea, #764ba2);
      background-clip: text;
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 10px;
    }

    .header p {
      font-size: 1rem;
      color: #666;
    }

    /* ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ */
    .realtime-status {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      margin-bottom: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .connection-status {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .status-indicator {
      width: 12px;
      height: 12px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .status-indicator.connected {
      background: #28a745;
    }

    .status-indicator.disconnected {
      background: #dc3545;
    }

    .status-indicator.connecting {
      background: #ffc107;
    }

    .control-buttons {
      display: flex;
      gap: 10px;
    }

    .control-btn {
      padding: 8px 16px;
      border: none;
      border-radius: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .control-btn.primary {
      background: linear-gradient(45deg, #28a745, #20c997);
      color: white;
    }

    .control-btn.secondary {
      background: rgba(255, 255, 255, 0.8);
      color: #333;
      border: 1px solid #ddd;
    }

    .control-btn.danger {
      background: linear-gradient(45deg, #dc3545, #e83e8c);
      color: white;
    }

    .control-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
    }

    /* ë©”ì¸ ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ */
    .dashboard-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 20px;
      margin-bottom: 20px;
    }

    .dashboard-card {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 25px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .card-title {
      font-size: 1.3rem;
      font-weight: 600;
      margin-bottom: 20px;
      color: #333;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    /* ì‹¤ì‹œê°„ ê°ì • í‘œì‹œ */
    .current-emotion {
      text-align: center;
      margin-bottom: 25px;
    }

    .emotion-display {
      font-size: 6rem;
      margin-bottom: 15px;
      animation: emotionPulse 3s infinite;
    }

    .emotion-text {
      font-size: 1.5rem;
      font-weight: 600;
      color: #333;
      margin-bottom: 10px;
    }

    .emotion-confidence {
      font-size: 1rem;
      color: #666;
      background: rgba(102, 126, 234, 0.1);
      padding: 8px 16px;
      border-radius: 20px;
      display: inline-block;
    }

    /* ì‹¤ì‹œê°„ í†µê³„ */
    .realtime-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 15px;
    }

    .stat-item {
      text-align: center;
      padding: 15px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 10px;
    }

    .stat-label {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 5px;
    }

    .stat-value {
      font-size: 1.8rem;
      font-weight: bold;
      color: #333;
    }

    .stat-unit {
      font-size: 0.8rem;
      color: #999;
      margin-left: 4px;
    }

    /* ì‹¤ì‹œê°„ ì°¨íŠ¸ */
    .realtime-chart-container {
      position: relative;
      height: 300px;
    }

    .realtime-chart-container canvas {
      height: 100% !important;
    }

    /* íŒ¨í‚· ìŠ¤íŠ¸ë¦¼ */
    .packet-stream {
      max-height: 400px;
      overflow-y: auto;
      border: 1px solid #eee;
      border-radius: 10px;
      padding: 10px;
      background: rgba(248, 249, 250, 0.8);
    }

    .packet-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      margin-bottom: 5px;
      background: white;
      border-radius: 8px;
      border-left: 4px solid;
      animation: slideIn 0.3s ease-out;
    }

    .packet-item.calm { border-left-color: #28a745; }
    .packet-item.happy { border-left-color: #17a2b8; }
    .packet-item.anxious { border-left-color: #ffc107; }
    .packet-item.angry { border-left-color: #dc3545; }
    .packet-item.sad { border-left-color: #6f42c1; }

    .packet-info {
      flex: 1;
    }

    .packet-emotion {
      font-weight: 600;
      margin-bottom: 2px;
    }

    .packet-details {
      font-size: 0.8rem;
      color: #666;
    }

    .packet-time {
      font-size: 0.8rem;
      color: #999;
    }

    /* ê°ì • ë¶„í¬ */
    .emotion-distribution {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      gap: 10px;
      margin-top: 20px;
    }

    .emotion-bar {
      text-align: center;
    }

    .emotion-bar-item {
      height: 100px;
      background: linear-gradient(to top, #f8f9fa, #e9ecef);
      border-radius: 8px 8px 0 0;
      position: relative;
      overflow: hidden;
      margin-bottom: 10px;
    }

    .emotion-bar-fill {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      border-radius: 8px 8px 0 0;
      transition: height 0.5s ease;
    }

    .emotion-bar.calm .emotion-bar-fill { background: linear-gradient(to top, #28a745, #20c997); }
    .emotion-bar.happy .emotion-bar-fill { background: linear-gradient(to top, #17a2b8, #20c997); }
    .emotion-bar.anxious .emotion-bar-fill { background: linear-gradient(to top, #ffc107, #fd7e14); }
    .emotion-bar.angry .emotion-bar-fill { background: linear-gradient(to top, #dc3545, #e83e8c); }
    .emotion-bar.sad .emotion-bar-fill { background: linear-gradient(to top, #6f42c1, #e83e8c); }

    .emotion-bar-label {
      font-size: 0.8rem;
      font-weight: 500;
      color: #333;
    }

    .emotion-bar-value {
      font-size: 0.7rem;
      color: #666;
      margin-top: 2px;
    }

    /* ê°œì¸ì •ë³´ ë³´í˜¸ ì„¤ì • */
    .privacy-panel {
      grid-column: 1 / -1;
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 20px;
      backdrop-filter: blur(10px);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
    }

    .privacy-settings {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 15px;
    }

    .privacy-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px;
      background: rgba(255, 255, 255, 0.7);
      border-radius: 8px;
    }

    .privacy-item input[type="checkbox"] {
      width: 18px;
      height: 18px;
    }

    .privacy-item label {
      font-size: 0.9rem;
      color: #333;
      cursor: pointer;
    }

    /* ì• ë‹ˆë©”ì´ì…˜ */
    @keyframes pulse {
      0% { opacity: 1; }
      50% { opacity: 0.5; }
      100% { opacity: 1; }
    }

    @keyframes emotionPulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.05); }
      100% { transform: scale(1); }
    }

    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateX(-20px);
      }
      to {
        opacity: 1;
        transform: translateX(0);
      }
    }

    /* ë°˜ì‘í˜• ë””ìì¸ */
    @media (max-width: 1200px) {
      .dashboard-grid {
        grid-template-columns: 1fr;
      }
    }

    @media (max-width: 768px) {
      .dashboard {
        padding: 10px;
      }

      .realtime-status {
        flex-direction: column;
        gap: 15px;
        text-align: center;
      }

      .control-buttons {
        justify-content: center;
      }

      .emotion-display {
        font-size: 4rem;
      }

      .emotion-text {
        font-size: 1.2rem;
      }

      .realtime-stats {
        grid-template-columns: 1fr;
      }

      .emotion-distribution {
        grid-template-columns: repeat(3, 1fr);
      }

      .packet-stream {
        max-height: 300px;
      }
    }

    @media (max-width: 480px) {
      .emotion-distribution {
        grid-template-columns: repeat(2, 1fr);
      }

      .control-btn {
        padding: 6px 12px;
        font-size: 0.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="dashboard">
    <!-- í—¤ë” -->
    <header class="header">
      <h1>ğŸ”´ NetMood ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</h1>
      <p>ë„¤íŠ¸ì›Œí¬ íŠ¸ë˜í”½ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ìº¡ì²˜í•˜ê³  ê°ì •ì„ ë¶„ì„í•©ë‹ˆë‹¤</p>
    </header>

    <!-- ì‹¤ì‹œê°„ ìƒíƒœ í‘œì‹œ -->
    <div class="realtime-status">
      <div class="connection-status">
        <div class="status-indicator disconnected" id="connectionStatus"></div>
        <span id="connectionText">ì—°ê²° ëŠê¹€</span>
        <span id="packetCount">íŒ¨í‚·: 0ê°œ</span>
      </div>
      <div class="control-buttons">
        <button class="control-btn primary" onclick="startMonitoring()">â–¶ï¸ ëª¨ë‹ˆí„°ë§ ì‹œì‘</button>
        <button class="control-btn secondary" onclick="pauseMonitoring()">â¸ï¸ ì¼ì‹œì •ì§€</button>
        <button class="control-btn danger" onclick="stopMonitoring()">â¹ï¸ ì¤‘ì§€</button>
        <button class="control-btn secondary" onclick="exportData()">ğŸ’¾ ë°ì´í„° ë‚´ë³´ë‚´ê¸°</button>
      </div>
    </div>

    <!-- ë©”ì¸ ëŒ€ì‹œë³´ë“œ ê·¸ë¦¬ë“œ -->
    <div class="dashboard-grid">
      <!-- í˜„ì¬ ê°ì • ìƒíƒœ -->
      <div class="dashboard-card">
        <h2 class="card-title">
          ğŸ­ í˜„ì¬ ë„¤íŠ¸ì›Œí¬ ê°ì •
        </h2>
        <div class="current-emotion">
          <div class="emotion-display" id="currentEmotion">ğŸ˜Œ</div>
          <div class="emotion-text" id="emotionText">í‰ì˜¨í•œ ìƒíƒœ</div>
          <div class="emotion-confidence" id="emotionConfidence">ì‹ ë¢°ë„: 0%</div>
        </div>
        
        <div class="realtime-stats">
          <div class="stat-item">
            <div class="stat-label">ì´ íŒ¨í‚·</div>
            <div class="stat-value" id="totalPackets">0</div>
            <div class="stat-unit">ê°œ</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">íŒ¨í‚·/ì´ˆ</div>
            <div class="stat-value" id="packetsPerSecond">0</div>
            <div class="stat-unit">pps</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ëª¨ë‹ˆí„°ë§ ì‹œê°„</div>
            <div class="stat-value" id="monitoringTime">00:00</div>
          </div>
          <div class="stat-item">
            <div class="stat-label">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
            <div class="stat-value" id="lastUpdate">--:--</div>
          </div>
        </div>
      </div>

      <!-- ì‹¤ì‹œê°„ ì°¨íŠ¸ -->
      <div class="dashboard-card">
        <h2 class="card-title">
          ğŸ“ˆ ì‹¤ì‹œê°„ ê°ì • ì¶”ì´
        </h2>
        <div class="realtime-chart-container">
          <canvas id="realtimeChart"></canvas>
        </div>
      </div>

      <!-- íŒ¨í‚· ìŠ¤íŠ¸ë¦¼ -->
      <div class="dashboard-card">
        <h2 class="card-title">
          ğŸ“¦ ì‹¤ì‹œê°„ íŒ¨í‚· ìŠ¤íŠ¸ë¦¼
        </h2>
        <div class="packet-stream" id="packetStream">
          <div style="text-align: center; color: #999; padding: 20px;">
            íŒ¨í‚· ìº¡ì²˜ë¥¼ ì‹œì‘í•˜ë©´ ì—¬ê¸°ì— ì‹¤ì‹œê°„ íŒ¨í‚· ì •ë³´ê°€ í‘œì‹œë©ë‹ˆë‹¤
          </div>
        </div>
      </div>

      <!-- ê°ì • ë¶„í¬ -->
      <div class="dashboard-card">
        <h2 class="card-title">
          ğŸ“Š ê°ì • ë¶„í¬
        </h2>
        <div class="emotion-distribution">
          <div class="emotion-bar calm">
            <div class="emotion-bar-item">
              <div class="emotion-bar-fill" style="height: 0%"></div>
            </div>
            <div class="emotion-bar-label">í‰ì˜¨</div>
            <div class="emotion-bar-value" id="calmCount">0</div>
          </div>
          <div class="emotion-bar happy">
            <div class="emotion-bar-item">
              <div class="emotion-bar-fill" style="height: 0%"></div>
            </div>
            <div class="emotion-bar-label">ê¸°ì¨</div>
            <div class="emotion-bar-value" id="happyCount">0</div>
          </div>
          <div class="emotion-bar anxious">
            <div class="emotion-bar-item">
              <div class="emotion-bar-fill" style="height: 0%"></div>
            </div>
            <div class="emotion-bar-label">ë¶ˆì•ˆ</div>
            <div class="emotion-bar-value" id="anxiousCount">0</div>
          </div>
          <div class="emotion-bar angry">
            <div class="emotion-bar-item">
              <div class="emotion-bar-fill" style="height: 0%"></div>
            </div>
            <div class="emotion-bar-label">í™”ë‚¨</div>
            <div class="emotion-bar-value" id="angryCount">0</div>
          </div>
          <div class="emotion-bar sad">
            <div class="emotion-bar-item">
              <div class="emotion-bar-fill" style="height: 0%"></div>
            </div>
            <div class="emotion-bar-label">ìŠ¬í””</div>
            <div class="emotion-bar-value" id="sadCount">0</div>
          </div>
        </div>
      </div>
    </div>

    <!-- ê°œì¸ì •ë³´ ë³´í˜¸ ì„¤ì • -->
    <div class="privacy-panel">
      <h2 class="card-title">
        ğŸ”’ ê°œì¸ì •ë³´ ë³´í˜¸ ì„¤ì •
      </h2>
      <div class="privacy-settings">
        <div class="privacy-item">
          <input type="checkbox" id="anonymizeIPs" checked>
          <label for="anonymizeIPs">IP ì£¼ì†Œ ìµëª…í™”</label>
        </div>
        <div class="privacy-item">
          <input type="checkbox" id="filterSensitive" checked>
          <label for="filterSensitive">ë¯¼ê°í•œ ë°ì´í„° í•„í„°ë§</label>
        </div>
        <div class="privacy-item">
          <input type="checkbox" id="localOnly" checked>
          <label for="localOnly">ë¡œì»¬ ì²˜ë¦¬ë§Œ í—ˆìš©</label>
        </div>
        <div class="privacy-item">
          <input type="checkbox" id="autoCleanup">
          <label for="autoCleanup">ìë™ ë°ì´í„° ì •ë¦¬ (24ì‹œê°„)</label>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ì „ì—­ ë³€ìˆ˜
    let websocket = null;
    let realtimeChart = null;
    let isMonitoring = false;
    let monitoringStartTime = null;
    let packetStream = [];
    let maxPacketsInStream = 50;
    let chartData = {
      labels: [],
      datasets: [
        {
          label: 'í‰ì˜¨',
          data: [],
          borderColor: '#28a745',
          backgroundColor: 'rgba(40, 167, 69, 0.1)',
          tension: 0.4
        },
        {
          label: 'ê¸°ì¨',
          data: [],
          borderColor: '#17a2b8',
          backgroundColor: 'rgba(23, 162, 184, 0.1)',
          tension: 0.4
        },
        {
          label: 'ë¶ˆì•ˆ',
          data: [],
          borderColor: '#ffc107',
          backgroundColor: 'rgba(255, 193, 7, 0.1)',
          tension: 0.4
        },
        {
          label: 'í™”ë‚¨',
          data: [],
          borderColor: '#dc3545',
          backgroundColor: 'rgba(220, 53, 69, 0.1)',
          tension: 0.4
        },
        {
          label: 'ìŠ¬í””',
          data: [],
          borderColor: '#6f42c1',
          backgroundColor: 'rgba(111, 66, 193, 0.1)',
          tension: 0.4
        }
      ]
    };

    // ê°ì •ë³„ ì´ëª¨ì§€ì™€ ìƒ‰ìƒ ë§¤í•‘
    const emotionConfig = {
      'í‰ì˜¨': { emoji: 'ğŸ˜Œ', color: '#28a745' },
      'ê¸°ì¨': { emoji: 'ğŸ˜Š', color: '#17a2b8' },
      'ë¶ˆì•ˆ': { emoji: 'ğŸ˜°', color: '#ffc107' },
      'í™”ë‚¨': { emoji: 'ğŸ˜¡', color: '#dc3545' },
      'ìŠ¬í””': { emoji: 'ğŸ˜¢', color: '#6f42c1' }
    };

    // ì´ˆê¸°í™”
    document.addEventListener('DOMContentLoaded', function() {
      initializeChart();
      updatePrivacySettings();
      startTimeUpdate();
    });

    // ì°¨íŠ¸ ì´ˆê¸°í™”
    function initializeChart() {
      const ctx = document.getElementById('realtimeChart').getContext('2d');
      realtimeChart = new Chart(ctx, {
        type: 'line',
        data: chartData,
        options: {
          responsive: true,
          maintainAspectRatio: false,
          scales: {
            x: {
              display: true,
              title: {
                display: true,
                text: 'ì‹œê°„'
              }
            },
            y: {
              display: true,
              title: {
                display: true,
                text: 'ê°ì • ë¹ˆë„'
              },
              beginAtZero: true
            }
          },
          plugins: {
            legend: {
              display: true,
              position: 'top'
            }
          },
          animation: {
            duration: 750,
            easing: 'easeInOutQuart'
          }
        }
      });
    }

    // ì›¹ì†Œì¼“ ì—°ê²°
    function connectWebSocket() {
      const wsUrl = 'ws://localhost:8765';
      
      try {
        websocket = new WebSocket(wsUrl);
        
        websocket.onopen = function() {
          updateConnectionStatus('connected', 'ì—°ê²°ë¨');
          console.log('WebSocket ì—°ê²°ë¨');
        };
        
        websocket.onmessage = function(event) {
          try {
            const data = JSON.parse(event.data);
            handleWebSocketMessage(data);
          } catch (error) {
            console.error('ë©”ì‹œì§€ íŒŒì‹± ì˜¤ë¥˜:', error);
          }
        };
        
        websocket.onclose = function() {
          updateConnectionStatus('disconnected', 'ì—°ê²° ëŠê¹€');
          console.log('WebSocket ì—°ê²° ëŠê¹€');
          
          // ìë™ ì¬ì—°ê²° ì‹œë„
          if (isMonitoring) {
            setTimeout(connectWebSocket, 3000);
          }
        };
        
        websocket.onerror = function(error) {
          console.error('WebSocket ì˜¤ë¥˜:', error);
          updateConnectionStatus('disconnected', 'ì—°ê²° ì˜¤ë¥˜');
        };
        
      } catch (error) {
        console.error('WebSocket ì—°ê²° ì‹¤íŒ¨:', error);
        updateConnectionStatus('disconnected', 'ì—°ê²° ì‹¤íŒ¨');
      }
    }

    // ì›¹ì†Œì¼“ ë©”ì‹œì§€ ì²˜ë¦¬
    function handleWebSocketMessage(data) {
      switch (data.type) {
        case 'initial_data':
          handleInitialData(data.data);
          break;
        case 'analysis_update':
          handleAnalysisUpdate(data.data);
          break;
        case 'pong':
          // ì—°ê²° í™•ì¸ ì‘ë‹µ
          break;
        default:
          console.log('ì•Œ ìˆ˜ ì—†ëŠ” ë©”ì‹œì§€ íƒ€ì…:', data.type);
      }
    }

    // ì´ˆê¸° ë°ì´í„° ì²˜ë¦¬
    function handleInitialData(analysisData) {
      if (analysisData) {
        updateEmotionDisplay(analysisData.emotionPercentages);
        updateEmotionDistribution(analysisData.emotionStats);
      }
    }

    // ë¶„ì„ ì—…ë°ì´íŠ¸ ì²˜ë¦¬
    function handleAnalysisUpdate(analysisData) {
      updateEmotionDisplay(analysisData.emotionPercentages);
      updateEmotionDistribution(analysisData.emotionStats);
      updateChart(analysisData.emotionPercentages);
      updateLastUpdateTime();
    }

    // ê°ì • í‘œì‹œ ì—…ë°ì´íŠ¸
    function updateEmotionDisplay(emotionPercentages) {
      if (!emotionPercentages) return;

      // ì£¼ìš” ê°ì • ì°¾ê¸°
      const dominantEmotion = Object.keys(emotionPercentages).reduce((a, b) => 
        emotionPercentages[a] > emotionPercentages[b] ? a : b
      );

      const config = emotionConfig[dominantEmotion];
      if (config) {
        document.getElementById('currentEmotion').textContent = config.emoji;
        document.getElementById('currentEmotion').style.color = config.color;
        document.getElementById('emotionText').textContent = `${dominantEmotion}í•œ ìƒíƒœ`;
        document.getElementById('emotionConfidence').textContent = `ì‹ ë¢°ë„: ${emotionPercentages[dominantEmotion]}%`;
      }
    }

    // ê°ì • ë¶„í¬ ì—…ë°ì´íŠ¸
    function updateEmotionDistribution(emotionStats) {
      if (!emotionStats) return;

      const totalCount = Object.values(emotionStats).reduce((sum, stat) => sum + stat.count, 0);
      
      ['í‰ì˜¨', 'ê¸°ì¨', 'ë¶ˆì•ˆ', 'í™”ë‚¨', 'ìŠ¬í””'].forEach(emotion => {
        const count = emotionStats[emotion].count;
        const percentage = totalCount > 0 ? (count / totalCount) * 100 : 0;
        
        const barElement = document.querySelector(`.emotion-bar.${emotion.toLowerCase()} .emotion-bar-fill`);
        const valueElement = document.getElementById(`${emotion.toLowerCase()}Count`);
        
        if (barElement && valueElement) {
          barElement.style.height = `${percentage}%`;
          valueElement.textContent = count;
        }
      });
    }

    // ì°¨íŠ¸ ì—…ë°ì´íŠ¸
    function updateChart(emotionPercentages) {
      if (!emotionPercentages || !realtimeChart) return;

      const now = new Date();
      const timeLabel = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', second: '2-digit' });
      
      // ìƒˆë¡œìš´ ë°ì´í„° í¬ì¸íŠ¸ ì¶”ê°€
      chartData.labels.push(timeLabel);
      chartData.datasets[0].data.push(emotionPercentages.calm || 0);
      chartData.datasets[1].data.push(emotionPercentages.happy || 0);
      chartData.datasets[2].data.push(emotionPercentages.anxious || 0);
      chartData.datasets[3].data.push(emotionPercentages.angry || 0);
      chartData.datasets[4].data.push(emotionPercentages.sad || 0);

      // ìµœëŒ€ 20ê°œ ë°ì´í„° í¬ì¸íŠ¸ ìœ ì§€
      if (chartData.labels.length > 20) {
        chartData.labels.shift();
        chartData.datasets.forEach(dataset => dataset.data.shift());
      }

      realtimeChart.update('none');
    }

    // íŒ¨í‚· ìŠ¤íŠ¸ë¦¼ ì—…ë°ì´íŠ¸
    function addPacketToStream(packet) {
      const packetElement = document.createElement('div');
      packetElement.className = `packet-item ${packet.emotion.toLowerCase()}`;
      
      packetElement.innerHTML = `
        <div class="packet-info">
          <div class="packet-emotion">${packet.emotion} ${packet.protocol}</div>
          <div class="packet-details">${packet.source_ip} â†’ ${packet.destination_ip} (${packet.bytes} bytes)</div>
        </div>
        <div class="packet-time">${packet.timestamp}</div>
      `;

      const streamContainer = document.getElementById('packetStream');
      
      // ì²« ë²ˆì§¸ ë©”ì‹œì§€ ì œê±°
      if (streamContainer.children.length === 1 && streamContainer.children[0].style.textAlign === 'center') {
        streamContainer.innerHTML = '';
      }

      streamContainer.insertBefore(packetElement, streamContainer.firstChild);

      // ìµœëŒ€ ê°œìˆ˜ ì´ˆê³¼ ì‹œ ì˜¤ë˜ëœ ê²ƒ ì œê±°
      while (streamContainer.children.length > maxPacketsInStream) {
        streamContainer.removeChild(streamContainer.lastChild);
      }
    }

    // ì—°ê²° ìƒíƒœ ì—…ë°ì´íŠ¸
    function updateConnectionStatus(status, text) {
      const statusElement = document.getElementById('connectionStatus');
      const textElement = document.getElementById('connectionText');
      
      statusElement.className = `status-indicator ${status}`;
      textElement.textContent = text;
    }

    // íŒ¨í‚· ìˆ˜ ì—…ë°ì´íŠ¸
    function updatePacketCount(count) {
      document.getElementById('packetCount').textContent = `íŒ¨í‚·: ${count}ê°œ`;
      document.getElementById('totalPackets').textContent = count;
    }

    // ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ ì‹œê°„
    function updateLastUpdateTime() {
      const now = new Date();
      document.getElementById('lastUpdate').textContent = now.toLocaleTimeString('ko-KR');
    }

    // ëª¨ë‹ˆí„°ë§ ì‹œê°„ ì—…ë°ì´íŠ¸
    function startTimeUpdate() {
      setInterval(() => {
        if (monitoringStartTime) {
          const elapsed = Math.floor((Date.now() - monitoringStartTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          document.getElementById('monitoringTime').textContent = 
            `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }
      }, 1000);
    }

    // ê°œì¸ì •ë³´ ë³´í˜¸ ì„¤ì • ì—…ë°ì´íŠ¸
    function updatePrivacySettings() {
      const settings = {
        anonymize_ips: document.getElementById('anonymizeIPs').checked,
        filter_sensitive_data: document.getElementById('filterSensitive').checked,
        local_processing_only: document.getElementById('localOnly').checked,
        auto_cleanup: document.getElementById('autoCleanup').checked
      };

      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'privacy_settings',
          settings: settings
        }));
      }
    }

    // ëª¨ë‹ˆí„°ë§ ì‹œì‘
    function startMonitoring() {
      if (isMonitoring) return;
      
      isMonitoring = true;
      monitoringStartTime = Date.now();
      
      // ì›¹ì†Œì¼“ ì—°ê²°
      connectWebSocket();
      
      // ì„œë²„ì— ëª¨ë‹ˆí„°ë§ ì‹œì‘ ëª…ë ¹ ì „ì†¡
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'start_monitoring',
          settings: {
            anonymize_ips: document.getElementById('anonymizeIPs').checked,
            filter_sensitive_data: document.getElementById('filterSensitive').checked,
            local_processing_only: document.getElementById('localOnly').checked
          }
        }));
      }
      
      console.log('ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§ ì‹œì‘');
    }

    // ëª¨ë‹ˆí„°ë§ ì¼ì‹œì •ì§€
    function pauseMonitoring() {
      if (!isMonitoring) return;
      
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'pause_monitoring'
        }));
      }
      
      console.log('ëª¨ë‹ˆí„°ë§ ì¼ì‹œì •ì§€');
    }

    // ëª¨ë‹ˆí„°ë§ ì¤‘ì§€
    function stopMonitoring() {
      isMonitoring = false;
      monitoringStartTime = null;
      
      if (websocket) {
        websocket.send(JSON.stringify({
          type: 'stop_monitoring'
        }));
        websocket.close();
      }
      
      updateConnectionStatus('disconnected', 'ì—°ê²° ëŠê¹€');
      console.log('ëª¨ë‹ˆí„°ë§ ì¤‘ì§€');
    }

    // ë°ì´í„° ë‚´ë³´ë‚´ê¸°
    function exportData() {
      if (websocket && websocket.readyState === WebSocket.OPEN) {
        websocket.send(JSON.stringify({
          type: 'export_data'
        }));
      }
      
      console.log('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ìš”ì²­');
    }

    // ê°œì¸ì •ë³´ ë³´í˜¸ ì„¤ì • ë³€ê²½ ì´ë²¤íŠ¸
    document.getElementById('anonymizeIPs').addEventListener('change', updatePrivacySettings);
    document.getElementById('filterSensitive').addEventListener('change', updatePrivacySettings);
    document.getElementById('localOnly').addEventListener('change', updatePrivacySettings);
    document.getElementById('autoCleanup').addEventListener('change', updatePrivacySettings);
  </script>
</body>
</html>
